<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ë§ˆìŒ ë¹„ë²• ë§Œë“¤ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-gowun { font-family: 'Gowun Dodum', serif; }
        .icon-selected {
            transform: scale(1.25);
            color: #F59E0B; /* Tailwind amber-500 */
            text-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
        }

        @media print {
            body * { visibility: hidden; }
            #printableCardArea, #printableCardArea * { visibility: visible; }
            #printableCardArea {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                margin: 0; padding: 10mm; 
                border: none !important; box-shadow: none !important;
            }
            #printableCardArea > div { /* ì‹¤ì œ ì¹´ë“œ ì½˜í…ì¸  div */
                width: 100%; max-width: 190mm; /* A4 ìš©ì§€ í­ì— ë§ì¶¤ */
                margin: auto;
                box-shadow: none !important; border: none !important;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-amber-50 flex items-center justify-center min-h-screen p-4 sm:p-6">

    <div class="w-full max-w-3xl mx-auto">
        <div id="mainFormContainer" class="bg-white rounded-2xl shadow-lg p-6 sm:p-10 space-y-8 border-4 border-amber-100">
            <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-orange-800">ë‚˜ë§Œì˜ ë§ˆìŒ ë¹„ë²• ë§Œë“¤ê¸° âœ¨ğŸ³ğŸ’–</h1>
                <p class="text-gray-500 mt-2">í˜ë“¤ì—ˆë˜ ë§ˆìŒì„ ë‹¤ë…ì—¬ì£¼ëŠ” ë‚˜ë§Œì˜ ë¹„ë²•ì„ ë§Œë“¤ì–´ ë³´ì•„ìš”!</p>
            </header>

            <form id="mindForm" class="space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 bg-amber-50 p-4 rounded-lg">
                    <div>
                        <label for="schoolName" class="font-semibold text-gray-800">í•™êµ ì´ë¦„</label>
                        <input type="text" id="schoolName" name="schoolName" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ì˜ˆ: ë§ˆìŒì´ˆë“±í•™êµ">
                    </div>
                    <div>
                        <label for="className" class="font-semibold text-gray-800">í•™ë…„/ë°˜</label>
                        <input type="text" id="className" name="className" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ì˜ˆ: 5í•™ë…„ 1ë°˜">
                    </div>
                    <div>
                        <label for="studentName" class="font-semibold text-gray-800">ì´ë¦„</label>
                        <input type="text" id="studentName" name="studentName" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ì˜ˆ: í™ê¸¸ë™">
                    </div>
                </div>
                
                <div>
                    <label for="mindFood" class="text-xl font-semibold text-gray-800 block mb-2">ğŸ² 1. ì˜¤ëŠ˜ì˜ ë§ˆìŒ ìƒíƒœëŠ”?</label>
                    <p class="text-sm text-gray-500 mb-3">(ì˜ˆ: ì‹œí¼í•œ ë ˆëª¬ğŸ‹, ëœ¨ê±°ìš´ ê³ ì¶”ì¥ì°Œê°œğŸ”¥)</p>
                    <input type="text" id="mindFood" name="mindFood" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ë‚´ ë§ˆìŒì„ ìŒì‹ìœ¼ë¡œ í‘œí˜„í•˜ë©´...">
                </div>

                <div>
                    <label for="reason" class="text-xl font-semibold text-gray-800 block mb-2">ğŸ” 2. ë§ˆìŒì´ ì´ë ‡ê²Œ ëœ ì´ìœ ëŠ”?</label>
                    <textarea id="reason" name="reason" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ì–´ë–¤ ì¼ì´ ìˆì—ˆëŠ”ì§€ ê°„ë‹¨íˆ ì ì–´ë³´ì•„ìš”."></textarea>
                </div>

                <div>
                    <label class="text-xl font-semibold text-gray-800 block mb-3">ğŸ§‚ 3. ë§ˆìŒì„ ë‹¤ìŠ¤ë¦¬ëŠ” ì¬ë£Œë¥¼ ëª¨ì•„ë³´ì!</label>
                    <div id="ingredientsContainer" class="space-y-3"></div>
                    <button type="button" id="addIngredientBtn" class="mt-3 bg-amber-200 hover:bg-amber-300 text-amber-800 font-bold py-2 px-4 rounded-lg transition-transform duration-200 hover:scale-105">
                        + ì¬ë£Œ ì¶”ê°€í•˜ê¸°
                    </button>
                </div>

                <div>
                    <label for="recipeName" class="text-xl font-semibold text-gray-800 block mb-2">ğŸ½ï¸ 4. ë‚˜ë§Œì˜ ë§ˆìŒ ë ˆì‹œí”¼ ì´ë¦„ì€?</label>
                    <p class="text-sm text-gray-500 mb-3">(ì˜ˆ: ë§ˆìŒ ì§„ì • ìˆ˜í”„, ê¸°ë¶„ ì—…! ì´ˆì½”ì¼€ì´í¬)</p>
                    <input type="text" id="recipeName" name="recipeName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ë‚˜ë§Œì˜ ë©‹ì§„ ë ˆì‹œí”¼ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”!">
                </div>
                
                <div>
                    <label for="method" class="text-xl font-semibold text-gray-800 block mb-2">âœ¨ 5. ì™„ì„±ëœ ë§ˆìŒ ë¹„ë²• ë ˆì‹œí”¼ë¥¼ ì†Œê°œí•´ë³´ì!</label>
                    <textarea id="method" name="method" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ë ˆì‹œí”¼ ë§Œë“œëŠ” ë°©ë²•ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                </div>

                <div>
                    <label class="text-xl font-semibold text-gray-800 block mb-3">ğŸ¨ 6. ë‚˜ì˜ ë ˆì‹œí”¼ë¥¼ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•´ë³´ì!</label>
                    <label for="recipeImageUpload" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-5 rounded-lg border-2 border-dashed border-gray-300 text-center block transition">
                        ğŸ–¼ï¸ ë‚´ ì»´í“¨í„°ì—ì„œ ê·¸ë¦¼ íŒŒì¼ ì„ íƒí•˜ê¸°
                    </label>
                    <input type="file" id="recipeImageUpload" name="recipeImageUpload" class="hidden" accept="image/*">
                    <img id="imagePreview" class="hidden mt-4 rounded-lg max-w-xs mx-auto shadow-md" src="#" alt="ì„ íƒí•œ ê·¸ë¦¼ ë¯¸ë¦¬ë³´ê¸°">
                </div>

                <div>
                    <label for="usageTime" class="text-xl font-semibold text-gray-800 block mb-2">ğŸ’– 6. ì´ ë¹„ë²•ì„ ì–¸ì œ ì“°ë©´ ì¢‹ì„ê¹Œìš”?</label> <textarea id="usageTime" name="usageTime" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-400 focus:border-transparent transition" placeholder="ì´ ë¹„ë²•ì´ í•„ìš”í•œ ìˆœê°„ì„ ì ì–´ë³´ì„¸ìš”."></textarea>
                </div>


                <div class="flex flex-col sm:flex-row gap-4 pt-4">
                     <button type="button" id="previewBtn" class="w-full sm:w-2/3 bg-orange-400 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg transition-transform duration-200 hover:scale-105 shadow-md">
                        âœ¨ ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ë° ì™„ì„±!
                    </button>
                    <button type="button" id="resetBtn" class="w-full sm:w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition-transform duration-200 hover:scale-105 shadow-md">
                        ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°
                    </button>
                </div>
            </form>
        </div>

        <div id="previewModal" class="hidden fixed inset-0 bg-black/75 flex items-center justify-center p-4 z-50 transition-opacity duration-300 no-print">
            <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl relative max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <button id="closeModalBtn" class="absolute top-3 right-3 bg-gray-100 hover:bg-gray-300 text-gray-700 rounded-full p-1 w-8 h-8 flex items-center justify-center text-2xl font-bold leading-none">&times;</button>
                <h2 class="text-2xl font-bold text-center text-orange-700 mb-6">ë¯¸ë¦¬ë³´ê¸°: ë‚˜ì˜ ë§ˆìŒ ë¹„ë²• ì¹´ë“œ</h2>
                <div id="modalCardContentWrapper" class="border-2 border-dashed border-amber-300 rounded-lg p-1 sm:p-2"> 
                    </div>
                <div class="mt-6 text-center space-y-3 sm:space-y-0 sm:flex sm:flex-wrap sm:justify-center sm:gap-3">
                    <button type="button" id="printFromModalBtn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-5 rounded-lg transition shadow-md">ğŸ–¨ï¸ ì¸ì‡„ / PDFë¡œ ì €ì¥</button>
                    <button type="button" id="saveAsImageBtn" class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-5 rounded-lg transition shadow-md">ğŸ“· ê·¸ë¦¼ íŒŒì¼ë¡œ ì €ì¥</button>
                </div>
            </div>
        </div>
        
        <div id="printableCardArea" class="hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('mindForm');
            const previewBtn = document.getElementById('previewBtn'); // submitBtn -> previewBtn
            const resetBtn = document.getElementById('resetBtn');
            const ingredientsContainer = document.getElementById('ingredientsContainer');
            const addIngredientBtn = document.getElementById('addIngredientBtn');
            const recipeImageUpload = document.getElementById('recipeImageUpload'); // ID ìˆ˜ì •
            const imagePreview = document.getElementById('imagePreview');
            
            const previewModal = document.getElementById('previewModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const printFromModalBtn = document.getElementById('printFromModalBtn');
            const saveAsImageBtn = document.getElementById('saveAsImageBtn');
            const modalCardContentWrapper = document.getElementById('modalCardContentWrapper');
            const printableCardArea = document.getElementById('printableCardArea'); // ì¸ì‡„ìš© ì˜ì—­

            const iconSelector = document.getElementById('iconSelector'); // ì•„ì´ì½˜ ì„ íƒì
            const selectedIconInput = document.getElementById('selectedIcon'); // ì•„ì´ì½˜ ê°’ ì €ì¥ìš© (hidden input)
            const icons = iconSelector ? iconSelector.querySelectorAll('span') : [];


            if (iconSelector && selectedIconInput && icons.length > 0) {
                icons.forEach(icon => {
                    icon.addEventListener('click', () => {
                        icons.forEach(i => i.classList.remove('icon-selected'));
                        icon.classList.add('icon-selected');
                        selectedIconInput.value = icon.dataset.icon;
                    });
                });
            } else {
                // iconSelector ë˜ëŠ” selectedIconInputì´ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„ (ì‚¬ìš©ì ì½”ë“œì— ìˆì—ˆìœ¼ë¯€ë¡œ ìœ ì§€)
                // console.warn("Icon selector elements not found, icon selection feature might not work.");
            }


            addIngredientBtn.addEventListener('click', () => {
                const ingredientId = Date.now();
                const newIngredient = document.createElement('div');
                newIngredient.id = `ingredient-${ingredientId}`;
                newIngredient.className = 'flex items-center gap-2 mt-2'; // mt-2 ì¶”ê°€
                newIngredient.innerHTML = `
                    <input type="text" name="ingredientName" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-orange-400" placeholder="ì¬ë£Œ ì´ë¦„ (ì˜ˆ: ì¢‹ì•„í•˜ëŠ” ìŒì•…)">
                    <input type="text" name="ingredientEffect" class="flex-1 p-2 border border-gray-300 rounded-md focus:ring-orange-400" placeholder="íš¨ê³¼ (ì˜ˆ: ê¸°ë¶„ì´ ë°ì•„ì ¸ìš”)">
                    <button type="button" class="remove-ingredient-btn bg-red-500 text-white w-8 h-8 rounded-md hover:bg-red-600 font-bold text-sm">X</button>
                `;
                ingredientsContainer.appendChild(newIngredient);
            });

            ingredientsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-ingredient-btn')) {
                    e.target.parentElement.remove();
                }
            });

            recipeImageUpload.addEventListener('change', () => {
                const file = recipeImageUpload.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = "";
                    imagePreview.classList.add('hidden');
                }
            });

            resetBtn.addEventListener('click', () => {
                form.reset();
                ingredientsContainer.innerHTML = '';
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                modalCardContentWrapper.innerHTML = '';
                printableCardArea.innerHTML = '';
                previewModal.classList.add('hidden');
                if (icons.length > 0 && selectedIconInput) {
                    icons.forEach(i => i.classList.remove('icon-selected'));
                    selectedIconInput.value = '';
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            function checkFormValidity() {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                 // ë™ì  ì¬ë£Œ ìˆ˜ì§‘
                data.ingredients = Array.from(ingredientsContainer.children).map(row => ({
                    name: row.querySelector('input[name="ingredientName"]').value,
                    effect: row.querySelector('input[name="ingredientEffect"]').value
                })).filter(ing => ing.name && ing.name.trim());


                const requiredFields = ['mindFood', 'reason', 'recipeName', 'method', 'usageTime'];
                if(form.querySelector('input[name="feeling"]:checked')) { // ê¸°ë¶„ì€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
                    data.feeling = form.querySelector('input[name="feeling"]:checked').value;
                } else {
                    requiredFields.push('feeling_not_selected'); // ì„ì˜ì˜ ê°’ìœ¼ë¡œ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ìœ ë„
                }
                
                if (data.feeling === 'ê¸°íƒ€' && (!data.feelingEtc || !data.feelingEtc.trim())) {
                    alert('ê¸°íƒ€ ê°ì •ì„ ì„ íƒí•˜ì…¨ìœ¼ë©´, ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ˜Š');
                    document.getElementById('feelingEtc').focus();
                    return false;
                }
                if (data.ingredients.length === 0) {
                     alert('ì¬ë£ŒëŠ” 1ê°œ ì´ìƒ í•„ìš”í•´ìš”. ğŸ˜Š');
                     return false;
                }
                // ì•„ì´ì½˜ ì„ íƒ ìœ íš¨ì„± ê²€ì‚¬ (ì‚¬ìš©ì ì½”ë“œì— selectedIcon í•„ë“œê°€ ìˆì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€)
                if (selectedIconInput && !selectedIconInput.value) { // selectedIconInputì´ ì¡´ì¬í• ë•Œë§Œ ì²´í¬
                    alert('ì•„ì´ì½˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ˜Š');
                    return false;
                }
